[package]
name = "memapi"
version = "0.15.0"
edition = "2018"
rust-version = "1.56.0"
authors = ["echohumm"]
description = "A no_std-friendly memory allocation interface for raw buffers, with improved error reporting."
readme = "README.md"
license = "MIT OR Apache-2.0"
repository = "https://github.com/echohumm/memapi"
keywords = ["allocator", "no_std", "memory", "allocation"]
categories = ["no-std", "memory-management"]
include = [
    "src/**",
    "build.rs",
    "Cargo.toml",
    "README.md",
]
build = "build.rs"

[package.metadata.docs.rs]
features = ["full"]

[badges]
docsrs = { status = "passing" }
maintenance = { status = "actively-developed" }

[profile.bench]
opt-level = 3
lto = true
codegen-units = 1
debug = false
overflow-checks = false

[features]
default = ["c_str", "extra_extra_const"]

# msrv-changing features
extra_const = []
extra_extra_const = ["extra_const"]
c_str = []

# nightly support
nightly = []
metadata = ["nightly"]
sized_hierarchy = ["nightly"]
clone_to_uninit = ["nightly"]
specialization = ["nightly"]

all_nightly = ["metadata", "sized_hierarchy", "clone_to_uninit", "specialization"]

default_nightly = ["metadata", "clone_to_uninit", "specialization"]

# std support
std = []
std_with_libc = ["std", "libc/std"]

# main extensions
alloc_ext = []
alloc_slice = []
resize_in_place = []

# stats
stats = []

# external allocators
external_alloc = ["libc"]
jemalloc = ["memapi-jemalloc-sys", "external_alloc"]
jemalloc_in_place = ["jemalloc", "resize_in_place"]
mimalloc = ["memapi-mimalloc-sys", "external_alloc"]
mimalloc_in_place = ["mimalloc", "resize_in_place"]
external_allocs = ["jemalloc", "mimalloc"]
external_allocs_in_place = ["jemalloc_in_place", "mimalloc_in_place"]

# bundles
full_min = ["alloc_slice", "alloc_ext", "stats"]
full_min_std = ["full_min", "std"]
full_no_std_no_nightly = [
    "c_str",
    "extra_extra_const",
    "external_allocs_in_place",
    "full_min",
]
full_no_nightly = ["std", "full_no_std_no_nightly"]
full_no_std = ["all_nightly", "full_no_std_no_nightly"]
full = ["full_no_nightly", "full_no_std"]

# jemalloc feature tweaks
jemalloc_background_threads_runtime_support = ["memapi-jemalloc-sys/background_threads_runtime_support"]
jemalloc_background_threads = [
    "jemalloc_background_threads_runtime_support",
    "memapi-jemalloc-sys/background_threads",
]
jemalloc_debug = ["memapi-jemalloc-sys/debug"]
jemalloc_default = ["jemalloc_background_threads_runtime_support", "memapi-jemalloc-sys/default"]
jemalloc_disable_cache_oblivious = ["memapi-jemalloc-sys/disable_cache_oblivious"]
jemalloc_disable_initial_exec_tls = ["memapi-jemalloc-sys/disable_initial_exec_tls"]
jemalloc_profiling = ["memapi-jemalloc-sys/profiling"]
jemalloc_stats = ["memapi-jemalloc-sys/stats"]
jemalloc_unprefixed_malloc_on_supported_platforms = ["memapi-jemalloc-sys/unprefixed_malloc_on_supported_platforms"]

# mimalloc variants
mimalloc_arena = ["memapi-mimalloc-sys/arena"]
mimalloc_debug = ["memapi-mimalloc-sys/debug"]
mimalloc_debug_in_debug = ["memapi-mimalloc-sys/debug_in_debug"]
mimalloc_local_dynamic_tls = ["memapi-mimalloc-sys/local_dynamic_tls"]
mimalloc_no_thp = ["memapi-mimalloc-sys/no_thp"]
mimalloc_override = ["memapi-mimalloc-sys/override"]
mimalloc_secure = ["memapi-mimalloc-sys/secure"]

[[test]]
name = "base"
path = "tests/alloc.rs"

[[test]]
name = "dangerous"
path = "tests/potential_ub.rs"

[[test]]
name = "ext"
path = "tests/alloc_ext.rs"
required-features = ["alloc_ext"]

[[test]]
name = "jem"
path = "tests/jemalloc.rs"
required-features = ["jemalloc"]

[[test]]
name = "mim"
path = "tests/mimalloc.rs"
required-features = ["mimalloc"]

[[test]]
name = "slice"
path = "tests/alloc_slice.rs"
required-features = ["alloc_slice"]

[[test]]
name = "stats"
path = "tests/stats.rs"
required-features = ["stats", "std"]

# if this crate is ever built with a version above msrv, it will stop compiling because of this.
#  darn you, Cargo.lock
[dev-dependencies.criterion]
version = "^0.4.0"
default-features = false

[[bench]]
name = "bench"
path = "benches/bench.rs"
harness = false
required-features = ["alloc_ext"]

[dependencies]
libc = { version = "^0.2.0", optional = true, default-features = false }
memapi-jemalloc-sys = { version = "0.1.1", optional = true }
memapi-mimalloc-sys = { version = "0.1.2", optional = true, features = ["extended"] }
